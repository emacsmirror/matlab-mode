# File: tests/README-TEST-MATLAB-TREE-SITTER.org
# Copyright (C) 2025 Free Software Foundation, Inc.

#+startup: showall
#+startup: logdone
#+startup: inlineimages
#+startup: latexpreview
#+options: ^:{}    # a_{b} for subscript, a^{b} for superscript, leave a_b and a^b as is.
#+options: toc:nil   # toc:nil == no toc, toc:1 == one level, toc:2 == two levels, etc.

#+latex_header: \usepackage[margin=0.25in]{geometry}
#+latex_header: \usepackage{parskip}
#+latex_header: \usepackage{svg}
#+latex_header: \sloppy

#+title:  MATLAB tree-sitter only testing
#+author: John Ciolfi
#+date:   Nov-24-2025

Emacs leverages https://github.com/acristoffers/tree-sitter-matlab for matlab-ts-mode and thus has
tests for it. The tests below /only/ exercise the matlab tree-sitter grammar shared library and not the
use of the shared library by matlab-ts-mode.  The tests use Emacs as a "test driver".

* Setup

To run the tests,

1. Install Emacs 30 or later and validate emacs is on your system path and runs the desired version:

   #+begin_src bash
     emacs --version
   #+end_src

   Often package managers will contain Emacs 30.

   - On Debian 12, you can install Emacs 30 using:

     #+begin_src bash
       apt update
       apt -t bookworm-backports install emacs
     #+end_src

   - On Mac, you can install Emacs 30 from https://emacsformacosx.com/

2. Install Emacs-MATLAB-Mode

   #+begin_src bash
     cd /YOUR/WORK/DIRECTORY   # Any directory is fine

     git clone https://github.com/mathworks/Emacs-MATLAB-Mode.git
     cd Emacs-MATLAB-Mode
     make lisp
   #+end_src

3. Build the matlab tree-sitter grammar

   The grammar shared library must be named =libtree-sitter-matlab.SLIB_EXT= where SLIB_EXT is =so=
   on Linux, =dylib= on Mac, or =dll= on Windows.

   By default, the shared library should be placed in
   =~/.emacs.d/tree-sitter/libtree-sitter-matlab.SLIB_EXT=.  You can place it in another location
   and tell Emacs where it is using the =-libtree-sitter-matlab= switch in the tests below.

   ABI 14 is required by Emacs 30 which we get via:

   #+begin_src bash
     cd /YOUR/WORK/DIRECTORY
     git clone https://github.com/acristoffers/tree-sitter-matlab
     cd tree-sitter-matlab

     git checkout abi/14
   #+end_src

   Build. See [[file:doc/install-matlab-tree-sitter-grammar.org][doc/install-matlab-tree-sitter-grammar.org]]

   - Linux

     #+begin_src bash
       cd /YOUR/WORK/DIRECTORY/tree-sitter-matlab/src
       cc -fPIC -O -c -I. parser.c
       cc -fPIC -O -c -I. scanner.c
       cc -fPIC -shared parser.o scanner.o -o ~/.emacs.d/tree-sitter/libtree-sitter-matlab.so
     #+end_src

   - MacOS

     #+begin_src bash
       cd /YOUR/WORK/DIRECTORY/tree-sitter-matlab/src
       cc -fPIC -O -c -I. parser.c
       cc -fPIC -O -c -I. scanner.c
       cc -fPIC -shared parser.o scanner.o -o ~/.emacs.d/tree-sitter/libtree-sitter-matlab.dylib
     #+end_src

   - Windows

     Note, update the path below for the version of Visual Studio you are using.

     #+begin_src bash
       mkdir %HOME%\.emacs.d\tree-sitter
       cd \YOUR\WORK\DIRECTORY\tree-sitter-matlab\src
       "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat"
       cl /LD /I src\tree_sitter src\parser.c src\scanner.c /link /out:%HOME%\.emacs.d\tree-sitter\libtree-sitter-matlab.dll
     #+end_src

* Test: sweep-test-matlab-ts-grammar.sh

Check matlab tree-sitter parse by /sweeping/ over the =*.m= files in a directory tree.

This validates that if MATLAB tree-sitter parse has ERROR nodes that the MATLAB codeIssues command,
https://www.mathworks.com/help/matlab/ref/codeissues.html says the file has syntax issues (issue
severity of error).  Likewise, if MATLAB tree-sitter parse says no syntax errors, this test confirms
that the MATLAB codeIssues command reports the same.

To use sweep-test-matlab-ts-grammar.sh

1. Run sweep test

   #+begin_src bash
     cd /PATH/TO/DIRECTORY/CONTAINING/MFILES
     /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/sweep-test-matlab-ts-grammar.sh
   #+end_src

   If your grammar shared library is not located at
   =~/.emacs.d/tree-sitter/libtree-sitter-matlab.SLIB_EXT=, add option

   : /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/sweep-test-matlab-ts-grammar.sh -libtree-sitter-matlab /PATH/TO/libtree-sitter-matlab.SLIB_EXT

2. Results

   - *sweep-test-matlab-ts-grammar.log*

     This lists the files parsed and whether or not they have syntax errors.

   - *sweep-test-matlab-ts-grammar.result.txt*

     This is created if the matlab command is available (=which matlab=). The codeIssues() MATLAB
     command is used to compare MATLAB parse v.s. the matlab tree-sitter parse and has sections:

     : Files-with-parse-error-nodes-but-pass-syntax-checker-fun:
     :   <files with tree-sitter error nodes>
     :
     : Files-that-parsed-successfully-but-failed-syntax-checker-fun:
     :   <files without tree-sitter error nodes>
     :
     : Total-consistently-parsed-files: M of N

* Test: test-matlab-ts-mode-parser.sh

This test loops over all =*.m= files under the [[file:test-matlab-ts-mode-parser-files][./test-matlab-ts-mode-parser-files]] directory tree and
compares the matlab tree-sitter annotated parse tree against =*_expected.txt=. In this directory, we
have paired files, =NAME.m= and =NAME_expected.txt= where =NAME.m= contains MATLAB code and
=NAME_expected.txt= is the expected annotated parse tree.

1. Run parser test

   #+begin_src bash
     cd /PATH/TO/DIRECTORY/CONTAINING/MFILES
     /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/test-matlab-ts-mode-parser.sh
   #+end_src

   If your grammar shared library is not located at
   =~/.emacs.d/tree-sitter/libtree-sitter-matlab.SLIB_EXT=, add option

   : /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/test-matlab-ts-mode-parser.sh -libtree-sitter-matlab /PATH/TO/libtree-sitter-matlab.SLIB_EXT

2. Results

   If the annotated parse tree for =NAME.m= doesn't match NAME_expected.txt, you will see:

   #+begin_example
     (("Test: /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/test-matlab-ts-mode-parser-files/parser_cell.m"
       "Got: /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/test-matlab-ts-mode-parser-files/parser_cell_expected.txt~"
       "Expected: /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/test-matlab-ts-mode-parser-files/parser_cell_expected.txt"))
   #+end_example

   and you can compare the 'Got' file with the 'Expected' file.

   Difference in the annotated parse tree could be okay, in which case we'll need to update the
   =*_expected.txt= baselines.

** test-matlab-ts-mode-parser annotated Parse Tree, NAME_expected.txt

The annotate parse tree is a concrete syntax tree for the current buffer.  The tree contains named
and anonymous nodes.  Given:

 #+begin_src matlab
   a = 1;
   b = 2;
   c = a + b;
 #+end_src

the annotated parse tree is:

#+begin_example
  (source_file<1,28>
   (assignment<1,6>
    left: (identifier[1,2]@{a}@)
    =[3,4]
    right: (number[5,6]@{1}@))
   ;[6,7]
   (assignment<8,13>
    left: (identifier[8,9]@{b}@) =[10,11]
    right: (number[12,13]@{2}@))
   ;[13,14]
   (assignment<15,24> left: (identifier[15,16]@{c}@) =[17,18]
    right: (binary_operator<19,24>
            left: (identifier[19,20]@{a}@) +[21,22]
            right: (identifier[23,24]@{b}@)))
   ;[24,25] \\n[25,28])
#+end_example

which contains:

- leaf named nodes: "identifier" "number"

- leaf anonymous nodes (node has same name as code text):  "=" "+" "\n"

- non-leaf nodes: "source_file" "assignment" "binary_operator"

Notice that near each node we have a range of form =<START,END>= or =[START,END]= where the node
text starts at START point and ends one before END point. The point is the logical character
position in the buffer.  The length of text for the node is =END-START=.  For named nodes, the first
50 characters of the node text is shown in =@{NODE_TEXT}@=.

** M-x t-utils-view-parse-tree

You can view the annotated parse tree of a =*.m= file using:

1. Run Emacs
   : emacs
2. Load t-utils.el
   : M-x load-file RET /YOUR/WORK/DIRECTORY/Emacs-MATLAB-Mode/tests/t-utils.el RET
3. View a =*.m= file
   : C-x C-f NAME.m
4. View the annotated parse tree
   : M-x t-utils-view-parse-tree
   You can click with mouse or type RET on the =[START,END]= ranges to highlight the text in
   =NAME.m=.

#  LocalWords:  showall backports libtree SLIB dylib ABI abi MFILES utils VC vcvars
