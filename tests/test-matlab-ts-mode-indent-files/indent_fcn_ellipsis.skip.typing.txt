# -*- org -*-

Don't seem to have enough info to get typing via line-by-line.
Given foo.m containg, TAB on the 3rd line using the following patch works.

#+begin_src matlab
  function ...
      [    ...
       a,  ...
#+end_src

which has parse tree

#+begin_example
(function_definition function name: (line_continuation)
 (ERROR [)
 (line_continuation) (identifier) , (line_continuation) \n)
#+end_example

If we then add a 4th line
#+begin_src matlab
  function ...
      [    ...
       a,  ...
      b ...
#+end_src

We don't have enough info to indent (TAB on 4th line). For the 4 lines, we have parse tree:

#+begin_example
(function_definition function name: (line_continuation)
 (ERROR [)
 (line_continuation) (identifier) , (line_continuation)
 (block (identifier) (line_continuation) \n \n))
#+end_example

#+begin_src diff
--- matlab-ts-mode.el	2025-10-29 11:56:39.000000000 -0400
+++ matlab-ts-mode-fcn-cont.el	2025-10-29 11:55:24.447575406 -0400
@@ -2015,6 +2015,23 @@
 
     (cons prev-sibling-to-check prev-sibling-error-node)))
 
+(defun matlab-ts-mode--is-near-ancestor-an-error (node parent)
+  "Is NODE or PARENT an error node or within a near error node?"
+  ;; Is node, parent, or grandparent an error? We could look to other ancestors,
+  ;; but that would indicate many syntax errors and result in unexpected indent.
+  (or (and node (string= (treesit-node-type node) "ERROR"))
+      (string-match-p (rx (seq bos (or "ERROR" "\n") eos)) (treesit-node-type parent))
+      (equal (treesit-node-type (treesit-node-parent parent)) "ERROR")))
+
+(defun matlab-ts-mode--is-near-sibling-an-error (node)
+  "Is NODE near sibling an error node, if so return the error node."
+  (let ((prev-sibling (treesit-node-prev-sibling node)))
+    (while (and prev-sibling
+                (string= (treesit-node-type prev-sibling) "line_continuation"))
+      (setq prev-sibling (treesit-node-prev-sibling prev-sibling)))
+    (when (string= (treesit-node-type prev-sibling) "ERROR")
+      prev-sibling)))
+
 (cl-defun matlab-ts-mode--i-next-line-matcher (node parent bol &rest _)
   "Matcher for indent on a newline being inserted when in presence of errors.
 If so, set `matlab-ts-mode--i-next-line-pair'.
@@ -2049,11 +2066,8 @@
       (setq parent last-child-of-error-node))
 
     (when (or last-child-of-error-node
-              ;; Is node, parent, or grandparent an error? We could look to other ancestors,
-              ;; but that would indicate many syntax errors and result in unexpected indent.
-              (and node (string= (treesit-node-type node) "ERROR"))
-              (string-match-p (rx (seq bos (or "ERROR" "\n") eos)) (treesit-node-type parent))
-              (equal (treesit-node-type (treesit-node-parent parent)) "ERROR"))
+              (matlab-ts-mode--is-near-ancestor-an-error node parent)
+              (matlab-ts-mode--is-near-sibling-an-error node))
 
       (let ((node-to-check (or last-child-of-error-node node parent))
             ancestor-error-node ;; is node, parent, or one of it's ancestors an ERROR?
@@ -2090,7 +2104,11 @@
         ;; We use regular matching rules when there is NO error.
         (when (and (not ancestor-error-node)
                    (not prev-sibling-error-node))
-          (cl-return-from matlab-ts-mode--i-next-line-matcher nil))
+          (when prev-sibling-to-check
+            (setq ancestor-to-check nil
+                  prev-sibling-error-node (matlab-ts-mode--is-near-sibling-an-error node)))
+          (when (not prev-sibling-error-node)
+            (cl-return-from matlab-ts-mode--i-next-line-matcher nil)))
 
         (let ((anchor-node (or ancestor-to-check
                                prev-sibling-to-check)))
@@ -3142,7 +3160,7 @@
                      ;;        in1,  ... comment about in1
                      ;; See: test-matlab-ts-mode-on-save-fixes-files/on_save_no_fix_syntax_error.m
                      (cl-return))
-
+                   
                    (let* ((def-name-node (treesit-node-child-by-field-name child "name"))
                           (def-name (treesit-node-text def-name-node))
                           (file-name (file-name-nondirectory (or (buffer-file-name) (buffer-name))))
#+end_src
